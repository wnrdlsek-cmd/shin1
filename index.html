<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>익명</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color:#0b1220; color:#e6edf3; font-family:Arial, sans-serif; }
  .container{ max-width:800px; margin:auto; padding:20px; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp, 
  query, orderBy, onSnapshot, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { 
  getStorage, ref as storageRef, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqjmjuHR9c9LU3fw-opriDk4TA2sdw-N8",
  authDomain: "shin1-35930.firebaseapp.com",
  projectId: "shin1-35930",
  storageBucket: "shin1-35930.firebasestorage.app",
  messagingSenderId: "341705553561",
  appId: "1:341705553561:web:b071abdf4b15e966eb2a08",
  measurementId: "G-86NJYXDMC4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

window.__fb = {db, storage};
</script>
</head>

<body>
<div class="container">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">익명</h1>
    <a href="write.html" class="px-4 py-2 bg-blue-700 rounded text-white">글쓰기</a>
  </div>

  <div id="posts"></div>
</div>

<script type="module">
import { collection, query, orderBy, onSnapshot, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const db = window.__fb.db;

function getIsAdmin() {
  return sessionStorage.getItem('isAdmin') === '1';
}

function loadPosts() {
  const postsEl = document.getElementById("posts");
  postsEl.innerHTML = "불러오는 중...";

  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));

  onSnapshot(q, (snap) => {
    postsEl.innerHTML = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className = "p-4 bg-slate-900 rounded mb-4";

      let html = `
        <p class='text-sm text-gray-300'>익명</p>
        <div class='mt-2 whitespace-pre-wrap'>${d.content || ''}</div>
      `;
      
      if(d.imageUrl) {
        html += `<img src="${d.imageUrl}" 
                 class="max-w-full mt-2 rounded cursor-pointer"
                 onclick="window.open(this.src)">`;
      }

      if(getIsAdmin()) {
        html += `<button data-id="${docSnap.id}" class="delete-btn text-red-400 text-sm mt-2">삭제</button>`;
      }

      div.innerHTML = html;
      postsEl.appendChild(div);
    });

    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.onclick = async(e) => {
        if(confirm("삭제할까요?")) {
          await deleteDoc(doc(db,"posts",e.target.dataset.id));
        }
      };
    });
  });
}

loadPosts();
</script>
</body>
</html>
